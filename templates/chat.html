<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ChatC5</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet"/>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dockerfile.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>

  <style>
    :root{
      --sidebar-w:260px;
      --sidebar-bg:#202123;
      --bg:#343541;
      --card:#444654;
      --text:#ececf1;
      --muted:#a0a0b0;
      --primary:#10a37f;
      --primary-2:#1a7f64;
      --border:#4d4d4f;
      --input:#40414f;
      --input-b:#565869;
      --radius:12px;
      --shadow:0 8px 24px rgba(0,0,0,.25);
      --trans:.2s ease;
      --error:#f44336;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif;
      color:var(--text); background:var(--bg);
      height:100vh; display:flex; overflow:hidden;
    }

    /* Sidebar */
    .sidebar{
      width:var(--sidebar-w); background:var(--sidebar-bg); border-right:1px solid var(--border);
      height:100vh; display:flex; flex-direction:column; z-index:5; transition:transform var(--trans);
      overflow:auto;
    }
    .logo-row{display:flex; align-items:center; gap:10px; padding:16px; border-bottom:1px solid var(--border)}
    .logo{width:36px;height:36px;border-radius:8px;background:var(--primary);display:grid;place-items:center;font-weight:800}
    .logo-text{font-weight:700}
    .new-chat{margin:14px;border:1px solid var(--input-b); background:transparent; color:var(--text);
      border-radius:10px; height:42px; display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;}
    .new-chat:hover{background:rgba(255,255,255,.06)}
    .chats{flex:1; overflow:auto; padding:6px 10px}
    .chats-title{font-size:12px; color:var(--muted); margin:10px 6px}
    .chat-item{display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; cursor:pointer; position:relative;}
    .chat-item:hover{background:rgba(255,255,255,.06)}
    .chat-item .trash{position:absolute; right:8px; opacity:0; background:transparent; border:0; color:var(--muted); cursor:pointer}
    .chat-item:hover .trash{opacity:1}
    .profile{
      border-top:1px solid var(--border); padding:10px 12px;
      position:sticky; bottom:0; background:var(--sidebar-bg);
      padding-bottom: max(10px, env(safe-area-inset-bottom));
    }
    .profile-btn{display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; cursor:pointer;}
    .profile-btn:hover{background:rgba(255,255,255,.06)}
    .avatar{width:32px;height:32px;border-radius:8px;background:var(--primary);display:grid;place-items:center}
    .dropdown{position:absolute; left:12px; right:12px; bottom:64px; background:var(--sidebar-bg);
      border:1px solid var(--border); border-radius:12px; overflow:hidden; display:none}
    .dropdown.show{display:block}
    .drop-item{display:flex; gap:12px; align-items:center; padding:12px 14px; cursor:pointer}
    .drop-item:hover{background:rgba(255,255,255,.06)}
    .divider{height:1px;background:var(--border)}

    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:4}
    .overlay.show{display:block}
    @media (max-width: 920px){
      .sidebar{position:fixed; inset:0 auto 0 0; transform:translateX(-100%)}
      .sidebar.active{transform:translateX(0)}
    }

    /* Main */
    .main{flex:1; display:flex; flex-direction:column; height:100vh}
    .topbar{height:60px; display:flex; align-items:center; justify-content:center; border-bottom:1px solid var(--border); position:relative}
    .toggle{position:absolute; left:12px; background:transparent; border:0; color:var(--text); font-size:20px; display:none}
    @media (max-width: 920px){ .toggle{display:block} }
    .title{font-weight:700}

    .chat{flex:1; overflow:auto; padding:22px; display:flex; flex-direction:column; position:relative}

    .welcome{max-width:900px; margin:36px auto; background:rgba(255,255,255,.04); border:1px solid var(--border);
      border-radius:16px; box-shadow:var(--shadow); padding:26px}
    .hero{display:grid; grid-template-columns:1.2fr .8fr; gap:18px; align-items:center}
    .hero h1{font-size:30px; line-height:1.15; margin-bottom:10px}
    .hero p{color:var(--muted)}
    .caps{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    .cap{background:rgba(255,255,255,.05); border:1px solid var(--border); border-radius:12px; padding:14px}
    .cap i{color:var(--primary); margin-right:8px}
    @media (max-width: 920px){
      .hero{grid-template-columns:1fr}
      .caps{grid-template-columns:1fr}
      .welcome{margin:16px}
    }

    /* Chat area */
    .messages{max-width:900px; width:100%; margin:0 auto; display:flex; flex-direction:column; gap:18px; padding-bottom:24px}
    .row{display:flex; gap:12px; align-items:flex-start; min-width:0;}
    .who{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;flex-shrink:0}
    .who.user{background:var(--primary)}
    .who.bot{background:#5436da}

    .bubble{
      max-width:100%;
      width:100%;
      min-width:0;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px 16px;
      box-shadow:var(--shadow);
      flex:1;
      overflow:hidden;
      word-wrap: break-word;
    }

    .markdown{line-height:1.7; font-size:16px; word-wrap:break-word; overflow-wrap:anywhere; max-width:100%}
    .markdown p{margin:0 0 12px}
    .markdown p:last-child{margin:0}
    .markdown ul, .markdown ol{margin:0 0 12px 20px}
    .markdown h1,.markdown h2,.markdown h3{margin:10px 0; line-height:1.2}
    .markdown img{max-width:100%; height:auto; border-radius:10px}
    .markdown table{display: block; width: 100%; overflow-x: auto; margin:12px 0; border-collapse: collapse;}
    .markdown th,.markdown td{border:1px solid #2a2a2a; padding:8px 10px; text-align:left}
    .markdown th{background:#2a2a2a}

    .markdown code{font-family:"Fira Code",monospace; background:#1e1e1e; padding:2px 6px; border-radius:6px; white-space:pre-wrap}
    .markdown pre{
      background:#1e1e1e;
      border-radius:12px;
      border:1px solid #2a2a2a;
      padding:12px;
      margin:12px 0;
      max-height:60vh;
      max-width:100%;
      overflow:auto;
    }
    .markdown pre code{
      font-size:14px; line-height:1.5;
      white-space:pre; display:block; overflow-x:auto; overflow-y:hidden;
    }

    .toolbar{display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; margin:4px 0 8px}
    .copy{background:transparent; border:0; color:var(--muted); cursor:pointer}
    .copy:hover{color:var(--text)}
    .stop{background: transparent; border: 1px solid var(--error); color: var(--error); border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;}
    .stop:hover{background: rgba(244, 67, 54, 0.1);}

    .streaming-wrap{display:flex; flex-direction:column; gap:8px}
    .streaming-plain{font-family:"Fira Code",monospace; background:#1e1e1e; border:1px solid #2a2a2a; border-radius:12px; padding:12px;
      white-space:pre-wrap; word-break:break-word; max-height:60vh; overflow:auto}

    .progress{height:3px; background:#2a2a2a; overflow:hidden; border-radius:6px}
    .indet{position:relative; height:100%; width:40%; left:-40%; background:linear-gradient(90deg,transparent,rgba(255,255,255,.7),transparent);
      animation:slide 1.3s infinite}
    @keyframes slide{0%{left:-40%}100%{left:100%}}

    .input{padding:16px 22px}
    .ibox{display:flex; align-items:center; border:1px solid var(--input-b); background:var(--input); border-radius:14px;
      transition:border var(--trans), box-shadow var(--trans)}
    .ibox:focus-within{border-color:var(--primary); box-shadow:0 0 0 2px rgba(16,163,127,.25)}
    textarea{flex:1;background:transparent;border:0;color:var(--text); padding:14px 16px; resize:none;
      height:56px; max-height:220px; font-size:16px}
    .send{width:46px;background:transparent;border:0;color:var(--text); font-size:18px; cursor:pointer}
    .send:disabled{opacity:.5; cursor:not-allowed}
    .hint{color:var(--muted); font-size:12px; text-align:center; margin-top:8px}

    .toBottom{position:sticky; bottom:16px; align-self:flex-end; margin-top:-36px; margin-right:8px; z-index:2;
      background:var(--card); border:1px solid var(--border); color:var(--text); border-radius:20px; padding:6px 10px; display:none; gap:6px; align-items:center; box-shadow:var(--shadow); cursor:pointer}
    .toBottom.show{display:inline-flex}

    @media (min-width: 921px){ .overlay{display:none!important} }

    @media (max-width: 768px) {
      .row { flex-direction: column; align-items: flex-start; }
      .who { margin-bottom: 8px; }
      .bubble { max-width: 90vw; }
      .toolbar { flex-direction: column; gap: 8px; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="logo-row">
      <div class="logo">C5</div><div class="logo-text">ChatC5</div>
    </div>
    <button class="new-chat" id="newChat"><i class="fa-solid fa-plus"></i> New chat</button>
    <div class="chats" id="chats">
      <div class="chats-title">Recent chats</div>
    </div>
    <div class="profile">
      <div class="profile-btn" id="profileBtn" aria-haspopup="true" aria-expanded="false">
        <div class="avatar"><i class="fa-solid fa-user"></i></div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Gibson Opoku</div>
          <div style="font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">user@example.com</div>
        </div>
        <i class="fa-solid fa-ellipsis-vertical"></i>
      </div>
      <div class="dropdown" id="profileMenu" role="menu">
        <div class="drop-item"><i class="fa-solid fa-user"></i><span>Profile</span></div>
        <div class="drop-item"><i class="fa-solid fa-gear"></i><span>Settings</span></div>
        <div class="divider"></div>
        <div class="drop-item"><i class="fa-solid fa-right-from-bracket"></i><span>Sign out</span></div>
      </div>
    </div>
  </aside>
  <div class="overlay" id="overlay"></div>

  <main class="main">
    <div class="topbar">
      <button class="toggle" id="toggle" aria-label="Open menu"><i class="fa-solid fa-bars"></i></button>
      <div class="title">ChatC5 3</div>
    </div>

    <div class="chat" id="chat">
      <section class="welcome" id="welcome">
        <div class="hero">
          <div>
            <h1>Welcome to ChatC5</h1>
            <p>Professional answers with code & commands colored, clean project tables, and precise debugging.</p>
          </div>
          <div class="caps">
            <div class="cap"><i class="fa-solid fa-code"></i><strong>Coding</strong><div style="color:var(--muted)">Python, JS/TS, SQL, Docker.</div></div>
            <div class="cap"><i class="fa-solid fa-terminal"></i><strong>Commands</strong><div style="color:var(--muted)">Linux, macOS, Windows.</div></div>
            <div class="cap"><i class="fa-solid fa-screwdriver-wrench"></i><strong>Debugging</strong><div style="color:var(--muted)">Paste errors; get fixes.</div></div>
            <div class="cap"><i class="fa-solid fa-table"></i><strong>Project Tables</strong><div style="color:var(--muted)">Path | Type | Purpose.</div></div>
          </div>
        </div>
      </section>

      <section class="messages" id="messages"></section>

      <button class="toBottom" id="toBottom" title="Jump to latest"><i class="fa-solid fa-arrow-down"></i><span>Latest</span></button>
    </div>

    <div class="input">
      <div class="ibox">
        <textarea id="input" placeholder="Message ChatC5…" rows="1"></textarea>
        <button class="send" id="send" aria-label="Send"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
      <div class="hint"><i class="fa-solid fa-bolt" style="margin-right:6px"></i>ChatC5 can make mistakes. Verify important info.</div>
    </div>
  </main>

<script>
(() => {
  const sidebar   = document.getElementById('sidebar');
  const overlay   = document.getElementById('overlay');
  const toggleBtn = document.getElementById('toggle');
  const newChat   = document.getElementById('newChat');
  const chatsBox  = document.getElementById('chats');
  const profileBtn= document.getElementById('profileBtn');
  const profileMenu=document.getElementById('profileMenu');

  const welcome   = document.getElementById('welcome');
  const messages  = document.getElementById('messages');
  const chatWrap  = document.getElementById('chat');
  const toBottom  = document.getElementById('toBottom');

  const input     = document.getElementById('input');
  const sendBtn   = document.getElementById('send');

  let sessionId = localStorage.getItem('chatc5_session_id');
  if (!sessionId){ sessionId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()); localStorage.setItem('chatc5_session_id', sessionId); }
  let chats = JSON.parse(localStorage.getItem('chatc5_chats') || '[]');
  let currentId = null;
  let abortController = null;

  let autoScroll = true;
  const isNearBottom = () => (chatWrap.scrollHeight - chatWrap.scrollTop - chatWrap.clientHeight) < 120;

  let isStreaming = false;

  chatWrap.addEventListener('scroll', () => {
    autoScroll = isNearBottom();
    toBottom.classList.toggle('show', !autoScroll && messages.style.display !== 'none');
  });
  toBottom.addEventListener('click', () => {
    chatWrap.scrollTo({ top: chatWrap.scrollHeight, behavior: 'smooth' });
  });

  document.addEventListener('DOMContentLoaded', () => {
    if (window.marked) {
      marked.setOptions({
        gfm: true,
        breaks: false,
        mangle: false,
        headerIds: false,
        highlight: function(code, lang){
          try{
            if (lang && window.hljs && hljs.getLanguage(lang)) {
              return hljs.highlight(code, {language: lang}).value;
            } else if (window.hljs){
              return hljs.highlightAuto(code).value;
            }
          }catch(e){}
          const div = document.createElement('div');
          div.textContent = code; return div.innerHTML;
        }
      });
    }
  });

  const save = () => localStorage.setItem('chatc5_chats', JSON.stringify(chats));
  const now  = () => new Date().toISOString();

  function isMobile(){ return window.innerWidth <= 920; }
  function openSidebar(){ if (isMobile()){ sidebar.classList.add('active'); overlay.classList.add('show'); } }
  function closeSidebar(){ sidebar.classList.remove('active'); overlay.classList.remove('show'); }

  toggleBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openSidebar(); });
  overlay.addEventListener('click', closeSidebar);
  document.addEventListener('click', (e)=>{
    if (isMobile() && sidebar.classList.contains('active')){
      const insideSidebar = sidebar.contains(e.target) || toggleBtn.contains(e.target);
      if (!insideSidebar) closeSidebar();
    }
  });

  profileBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    profileMenu.classList.toggle('show');
    profileBtn.setAttribute('aria-expanded', profileMenu.classList.contains('show') ? 'true' : 'false');
  });
  document.addEventListener('click', (e)=>{
    if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)){
      profileMenu.classList.remove('show');
      profileBtn.setAttribute('aria-expanded', 'false');
    }
  });

  input.addEventListener('input', ()=>{
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 220) + 'px';
  });

  input.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); submit(); }
  });
  sendBtn.addEventListener('click', submit);

  function renderChats(){
    const header = chatsBox.querySelector('.chats-title');
    chatsBox.innerHTML = '';
    if (header) chatsBox.appendChild(header);
    chats.forEach(c=>{
      const item = document.createElement('div');
      item.className = 'chat-item';
      item.dataset.id = c.id;
      item.innerHTML = `
        <i class="fa-regular fa-message"></i>
        <span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtmlInline(c.title)}</span>
        <button class="trash" title="Delete"><i class="fa-solid fa-trash"></i></button>
      `;
      item.addEventListener('click', ()=>{ loadChat(c.id); closeSidebar(); });
      item.querySelector('.trash').addEventListener('click', (e)=>{ e.stopPropagation(); deleteChat(c.id); });
      chatsBox.appendChild(item);
    });
  }

  function startChat(){
    const id = String(Date.now());
    const chat = { id, title:'New chat', messages:[] };
    chats.unshift(chat);
    currentId = id;
    messages.innerHTML = '';
    welcome.style.display = 'block';
    messages.style.display = 'flex';
    save(); renderChats(); input.focus();
  }

  function loadChat(id){
    const c = chats.find(x => x.id === id);
    if (!c) return;
    currentId = id;
    messages.innerHTML = '';
    c.messages.forEach(m => appendMessage(m.role, m.text, false));
    if (c.messages.length){ welcome.style.display='none'; messages.style.display='flex'; }
    else{ welcome.style.display='block'; messages.style.display='flex'; }
    setTimeout(()=> chatWrap.scrollTop = chatWrap.scrollHeight, 0);
  }

  function deleteChat(id){
    chats = chats.filter(x => x.id !== id);
    save(); renderChats();
    if (currentId === id) startChat();
  }

  newChat.addEventListener('click', startChat);

  function detectCommand(text){
    const oneLine = text.trim().split('\n').length === 1;
    const cliRx = /(^|\n)\s*(sudo|apt|apt-get|yum|dnf|brew|pip3?|python3?|node|npm|npx|pnpm|git|ls|cd|cp|mv|rm|cat|echo|grep|awk|sed|chmod|chown|systemctl|service|kubectl|docker)\b/;
    return oneLine && cliRx.test(text);
  }
  function isLikelyHTML(t){
    return /<!DOCTYPE|<html[\s>]|<head[\s>]|<body[\s>]|<style[\s>]|<script[\s>]/i.test(t);
  }
  function fenceIfCommand(text){
    if (!/```/.test(text) && detectCommand(text)){
      return '```bash\n' + text.trim() + '\n```';
    }
    return text;
  }
  function fenceIfHTML(text){
    if (isLikelyHTML(text) && !/```/.test(text)){
      return '```html\n' + text.trim() + '\n```';
    }
    return text;
  }

  function addToolbarBefore(preEl){
    const lang = ((preEl.querySelector('code')?.className || '').match(/language-([\w+-]+)/)||[])[1] || 'code';
    const toolbar = document.createElement('div');
    toolbar.className = 'toolbar';
    toolbar.innerHTML = `<span>${lang.toUpperCase()}</span><button class="copy"><i class="fa-regular fa-copy"></i> Copy</button>`;
    preEl.parentElement.insertBefore(toolbar, preEl);
    const copyBtn = toolbar.querySelector('.copy');
    copyBtn.addEventListener('click', ()=>{
      const code = preEl.querySelector('code');
      navigator.clipboard.writeText(code?.textContent || '');
      const old = copyBtn.innerHTML; copyBtn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
      setTimeout(()=>copyBtn.innerHTML = old, 1200);
    });
  }

  function renderMarkdown(text){
    const md = fenceIfCommand(text);
    const rawHtml = (window.marked ? marked.parse(md) : `<pre><code>${escapeHtml(md)}</code></pre>`);
    const safeHtml = (window.DOMPurify ? DOMPurify.sanitize(rawHtml, {USE_PROFILES:{html:true}}) : rawHtml);
    const container = document.createElement('div');
    container.className = 'markdown';
    container.innerHTML = safeHtml;
    if (window.hljs){ container.querySelectorAll('pre code').forEach(el=>hljs.highlightElement(el)); }
    container.querySelectorAll('pre').forEach(pre => addToolbarBefore(pre));
    return container;
  }

  function escapeHtml(s){ const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function escapeHtmlInline(s){ return String(s).replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

  function appendMessage(role, text, store=true){
    if (!currentId) startChat();
    const idx = chats.findIndex(c => c.id === currentId);
    if (idx === -1) return;

    if (store){
      if (role === 'user' && chats[idx].messages.length === 0){
        const t = text.replace(/\s+/g,' ').trim();
        chats[idx].title = (t || 'New chat').slice(0, 48) + (t.length > 48 ? '…':'');
        save(); renderChats();
      }
      chats[idx].messages.push({ role, text, time: now() });
      save();
    }

    if (role === 'user' && welcome.style.display !== 'none'){
      welcome.style.display='none'; messages.style.display='flex';
    }

    const row = document.createElement('div'); row.className = 'row';
    const who = document.createElement('div'); who.className = `who ${role}`;
    who.innerHTML = role === 'user' ? '<i class="fa-solid fa-user"></i>' : '<i class="fa-solid fa-robot"></i>';

    const bubble = document.createElement('div'); bubble.className = 'bubble';
    bubble.appendChild(renderMarkdown(text));

    row.appendChild(who); row.appendChild(bubble); messages.appendChild(row);
    if (autoScroll) chatWrap.scrollTop = chatWrap.scrollHeight;
  }

  function startStreamingBubble(){
    const row = document.createElement('div'); row.className = 'row';
    const who = document.createElement('div'); who.className = 'who bot'; who.innerHTML = '<i class="fa-solid fa-robot"></i>';
    const bubble = document.createElement('div'); bubble.className = 'bubble';

    const wrap = document.createElement('div'); wrap.className = 'streaming-wrap';
    const toolbar = document.createElement('div'); toolbar.className = 'toolbar'; 
    toolbar.innerHTML = `
      <span>Generating…</span>
      <button class="stop" id="stopBtn" title="Stop generating">
        <i class="fa-solid fa-stop"></i> Stop
      </button>
    `;
    const progress = document.createElement('div'); progress.className = 'progress'; 
    const ind = document.createElement('div'); ind.className = 'indet'; 
    progress.appendChild(ind);
    const plain = document.createElement('div'); plain.className = 'streaming-plain'; plain.textContent = '';

    wrap.appendChild(toolbar); wrap.appendChild(progress); wrap.appendChild(plain);
    bubble.appendChild(wrap);

    row.appendChild(who); row.appendChild(bubble); messages.appendChild(row);
    if (autoScroll) chatWrap.scrollTop = chatWrap.scrollHeight;

    let acc = '';
    function push(chunk){
      if (!chunk) return;

      if (acc && chunk.startsWith(acc)) {
        acc = chunk;
      } else if (!acc || !acc.endsWith(chunk)) {
        acc += chunk;
      }

      acc = acc.replace(/(^|\n)\s*(User:|Assistant:)\s*/g, '\n');
      plain.textContent = acc;
      if (autoScroll) chatWrap.scrollTop = chatWrap.scrollHeight;
    }

    function finalize(){
      bubble.innerHTML = '';
      bubble.appendChild(renderMarkdown(acc));
      if (autoScroll) chatWrap.scrollTop = chatWrap.scrollHeight;
      return acc;
    }

    return { bubble, push, finalize };
  }

  async function submit(){
    if (isStreaming) return;

    const text = input.value.trim(); 
    if (!text) return;
    input.value=''; 
    input.style.height='56px'; 
    sendBtn.disabled = true;
    isStreaming = true;

    const wantsCode = /^(build|write|create|generate|make|show)\b/i.test(text)
      || /```|<!DOCTYPE|<html|<body|<style|<script|\b(def |class |function |SELECT |INSERT |sudo |apt|yum|dnf|brew|pip|npm|npx|pnpm|git )/i.test(text);
    const prefix = wantsCode ? "Return only code or commands. No explanations.\n\n" : "";
    const payloadMsg = prefix + text;

    abortController = new AbortController();
    appendMessage('user', text, true);

    const streamer = startStreamingBubble();
    const stopBtn = streamer.bubble.querySelector('.stop');
    if (stopBtn) {
      stopBtn.addEventListener('click', () => {
        if (abortController) {
          abortController.abort();
          stopBtn.innerHTML = '<i class="fa-solid fa-ban"></i> Stopped';
          stopBtn.disabled = true;
        }
      });
    }

    let usedStream = false;
    try{
      const r = await fetch('/chat/stream', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message: payloadMsg, session_id: sessionId }),
        signal: abortController.signal
      });
      if (!r.ok || !r.body) throw new Error(String(r.status));
      usedStream = true;

      await readNdjsonStream(r.body, (delta)=> streamer.push(delta));
      const full = streamer.finalize();

      const idx = chats.findIndex(c => c.id === currentId);
      if (idx !== -1){ 
        chats[idx].messages.push({ role:'bot', text: full, time: now() }); 
        save(); 
        renderChats(); 
      }

    } catch(err) {
      if (err.name === 'AbortError') {
        const partial = streamer.finalize();
        const idx = chats.findIndex(c => c.id === currentId);
        if (idx !== -1){ 
          chats[idx].messages.push({ role:'bot', text: partial, time: now() }); 
          save(); 
          renderChats(); 
        }
        return;
      }
      if (!usedStream){
        try{
          const r = await fetch('/chat', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ message: payloadMsg, session_id: sessionId })
          });
          if (!r.ok) throw new Error(String(r.status));
          const data = await r.json();
          messages.removeChild(messages.lastElementChild);
          const clean = (data.reply || data.text || (typeof data === 'string' ? data : "I don't know."))
            .replace(/(^|\n)\s*(User:|Assistant:)\s*/g, '\n');
          appendMessage('bot', clean, true);
        }catch(e){
          try { messages.removeChild(messages.lastElementChild); } catch(_){}
          appendMessage('bot', 'Network error', true);
        }
      }else{
        const partial = streamer.finalize();
        const idx = chats.findIndex(c => c.id === currentId);
        if (idx !== -1){ 
          chats[idx].messages.push({ role:'bot', text: partial, time: now() }); 
          save(); 
          renderChats(); 
        }
      }
    } finally {
      abortController = null;
      sendBtn.disabled = false;
      isStreaming = false;
      if (isMobile()) closeSidebar();
    }
  }

  async function readNdjsonStream(stream, onChunk) {
    const reader = stream.getReader();
    const decoder = new TextDecoder('utf-8');
    let buffer = '';
    
    try {
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        
        buffer += decoder.decode(value, { stream: true });
        let lineEndIndex;
        
        while ((lineEndIndex = buffer.indexOf('\n')) >= 0) {
          const line = buffer.slice(0, lineEndIndex).trim();
          buffer = buffer.slice(lineEndIndex + 1);
          
          if (!line) continue;
          
          try {
            const obj = JSON.parse(line);
            if (obj && typeof obj.response === 'string') {
              onChunk(obj.response);
            }
            if (obj && obj.done === true) {
              return;
            }
          } catch (e) {
            console.error('Error parsing JSON:', e, 'Line:', line);
          }
        }
      }
      
      if (buffer.trim()) {
        try {
          const obj = JSON.parse(buffer.trim());
          if (obj && typeof obj.response === 'string') {
            onChunk(obj.response);
          }
        } catch (e) {
          console.error('Error parsing final JSON:', e, 'Buffer:', buffer);
        }
      }
    } finally {
      reader.releaseLock();
    }
  }

  function renderChatsOnBoot(){
    renderChats();
    if (chats.length === 0) startChat(); else loadChat(chats[0].id);
  }

  renderChatsOnBoot();
})();
</script>

</body>
</html>